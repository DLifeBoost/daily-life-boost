<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Life Boost</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #FAFAFA; color: #333; display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px;}
    .card { background:white; border-radius:16px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); padding:24px; width:100%; max-width:520px; }
    h1 { margin:0 0 8px 0; font-size:20px; color:#333; }
    .mission { font-size:18px; margin:18px 0; }
    .controls { display:flex; gap:10px; }
    button { border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn-done { background:#82B1FF; color:white; }
    .btn-skip { background:#FFC107; color:white; }
    .small { margin-top:10px; color:#666; font-size:13px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>Твоята мисия за днес</h1>
    <div id="mission" class="mission">...зареждам...</div>
    <div style="display:flex; gap:10px; margin-bottom:8px;">
      <button id="doneBtn" class="btn-done">Готово ✅</button>
      <button id="skipBtn" class="btn-skip">Пропусни ❌</button>
    </div>
    <div id="feedback" class="small"></div>
    <div class="small">Малка мисъл: <span id="quote">„Започни, където си.“</span></div>
    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;" />
    <div class="small">Локален потребител ID: <span id="uid"></span></div>
  </div>

<script>
  function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  let USER_ID = localStorage.getItem('dlifeboost_user_id');
  if (!USER_ID) {
    USER_ID = uuidv4();
    localStorage.setItem('dlifeboost_user_id', USER_ID);
  }
  document.getElementById('uid').innerText = USER_ID;

  let CURRENT_MISSION = null;

  async function loadMission() {
    document.getElementById('mission').innerText = '...зареждам...';
    const resp = await fetch('/api/mission');
    if (!resp.ok) {
      document.getElementById('mission').innerText = 'Грешка при зареждане.';
      return;
    }
    const json = await resp.json();
    CURRENT_MISSION = json.mission;
    document.getElementById('mission').innerText = CURRENT_MISSION.text;
  }

  async function sendHistory(status) {
    if (!CURRENT_MISSION) return;
    const body = {
      user_id: USER_ID,
      mission_id: CURRENT_MISSION.id,
      mission_date: new Date().toISOString().slice(0,10),
      status
    };
    const resp = await fetch('/api/history', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if (resp.ok) {
      document.getElementById('feedback').innerText = 'Записано: ' + status;
    } else {
      document.getElementById('feedback').innerText = 'Грешка при запис.';
    }
  }

  document.getElementById('doneBtn').addEventListener('click', () => {
    sendHistory('done');
  });
  document.getElementById('skipBtn').addEventListener('click', () => {
    sendHistory('skipped');
  });

  loadMission();
</script>
</body>
</html>
